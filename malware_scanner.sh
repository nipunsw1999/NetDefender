#!/bin/bash

# Check if YARA is installed
if ! command -v yara &> /dev/null; then
    echo "❌ YARA is not installed. Install it using: sudo apt install yara"
    exit 1
fi

# Check if correct arguments are provided
if [ "$#" -lt 1 ]; then
    echo "Usage: $0 <directory_to_scan> [yara_rule_file]"
    exit 1
fi

SCAN_DIR="$1"
YARA_RULE="${2:-malware_rule.yar}"  # Use default if not provided
LOG_FILE="scan_results_$(date +%Y%m%d_%H%M%S).log"

# Check if the YARA rule file exists
if [ ! -f "$YARA_RULE" ]; then
    echo "❌ YARA rule file not found: $YARA_RULE"
    exit 1
fi

# Check if the directory exists
if [ ! -d "$SCAN_DIR" ]; then
    echo "❌ Directory does not exist: $SCAN_DIR"
    exit 1
fi

# Clear the log file
> "$LOG_FILE"

echo "🔍 Scanning directory: $SCAN_DIR using rule: $YARA_RULE"
echo "Results will be saved to $LOG_FILE"

# Counter for scanned files
file_count=0
malware_count=0

# Scan files recursively
find "$SCAN_DIR" -type f | while read -r file; do
    ((file_count++))
    
    # Run YARA scan and handle potential errors
    result=$(yara "$YARA_RULE" "$file" 2>/dev/null)

    if [ -n "$result" ]; then
        ((malware_count++))
        echo "⚠️ Malware detected in $file:"
        echo "$result"
        echo "$(date '+%Y-%m-%d %H:%M:%S') ⚠️ Malware detected in $file: $result" >> "$LOG_FILE"
        rm $file
    else
        echo "✅ No threats found in $file"
    fi
done

echo "✅ Scan complete! Scanned $file_count files. Detected malware in $malware_count files."
echo "📄 Check log: $LOG_FILE"
