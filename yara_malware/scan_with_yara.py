import os
import subprocess

# Scan the entire system
SCAN_DIR = os.path.join(os.path.expanduser("~"), "Downloads")  # Root directory to scan everything
YARA_RULE = "malware_rule.yar"  

# List of files & directories to ignore
IGNORE_FILES = {"malware_rule.yar", "install_yara.sh"}
IGNORE_DIRS = {"/proc", "/sys", "/usr", "/dev", "/run", "/snap", "/mnt", "/media", "/var/lib", "/var/run"}

# Function to check if YARA is installed
def check_yara():
    try:
        subprocess.run(["yara", "--version"], check=True, capture_output=True, text=True)
        print("‚úÖ YARA is already installed.")
    except FileNotFoundError:
        print("‚ö†Ô∏è YARA is not installed. Installing now...")
        install_yara()

# Function to install YARA
def install_yara():
    try:
        subprocess.run(["sudo", "apt", "update"], check=True)
        subprocess.run(["sudo", "apt", "install", "-y", "yara"], check=True)
        print("‚úÖ YARA installation complete.")
    except subprocess.CalledProcessError:
        print("‚ùå Failed to install YARA. Please install it manually.")

# Function to scan files using YARA
def scan_files():
    print("\nüîç Starting YARA scan on the entire system...\n")

    for root, dirs, files in os.walk(SCAN_DIR):
        # Skip ignored directories
        if any(ignored in root for ignored in IGNORE_DIRS):
            continue

        for file in files:
            if file in IGNORE_FILES:
                continue

            file_path = os.path.join(root, file)

            try:
                result = subprocess.run(["yara", YARA_RULE, file_path],
                                        capture_output=True, text=True)
                if result.stdout:
                    print(f"‚ö†Ô∏è Malware detected in {file_path}:\n{result.stdout}")
                    # Automatically delete the malware file
                    try:
                        os.remove(file_path)
                        print(f"üóëÔ∏è Deleted malware file: {file_path}")
                    except PermissionError:
                        print(f"‚ùå Permission denied: Cannot delete {file_path}")
                    except Exception as e:
                        print(f"‚ùå Error deleting {file_path}: {e}")

                else:
                    print(f"‚úÖ No threats found in {file_path}")

            except PermissionError:
                print(f"‚ùå Permission denied: {file_path}")
            except Exception as e:
                print(f"‚ùå Error scanning {file_path}: {e}")

# Main execution
if __name__ == "__main__":
    check_yara()  # Ensure YARA is installed
    scan_files()  # Run the malware scan
