#!/bin/bash
# install_yara.sh - Automates YARA installation and setup >

echo "üì• Installing YARA..."
sudo apt install -y yara

# Get the directory where this script is located
INSTALL_DIR="$(cd "$(dirname "$0")" && pwd)"

echo "üìÇ Installing in: $INSTALL_DIR"

# Move to the installation directory
cd "$INSTALL_DIR" || exit

# Create or overwrite the YARA rule file
echo "‚ö° Creating YARA rule file: malware_rule.yar"
cat <<EOT > malware_rule.yar
rule Detect_Hidden_Delete_Payload
{
    meta:
        description = "Detects obfuscated or hidden delete>
        author = "NetDefender"
        date = "2025-03-08"

    strings:
        $delete_plain = "rm -rf" nocase
        $delete_base64 = "cm0gLXJm" // Base64 for "rm -rf"
        $delete_hex = { 72 6D ?? 2D 72 66 } // Flexible He>
        $python_exec = "os.system(" nocase
        $bash_exec = "bash -c" nocase
        $stegano_marker = "steghide" nocase
        $zip_magic = { 50 4B 03 04 } // ZIP file signature
        $jpg_exif = { FF E1 } // JPEG EXIF header
        $png_exif = { 89 50 4E 47 } // PNG header

    condition:
        any of them
}
EOT

# Create the YARA scanning script
echo "‚ö° Creating scan_with_yara.py..."
cat <<EOT > scan_with_yara.py
import os
import subprocess

# Scan the entire system
SCAN_DIR = os.path.expanduser("~")  # Root directory to scan everything
YARA_RULE = "malware_rule.yar"  

# List of files & directories to ignore
IGNORE_FILES = {"malware_rule.yar", "install_yara.sh"}
IGNORE_DIRS = {"/proc", "/sys", "/usr", "/dev", "/run", "/snap", "/mnt", "/media", "/var/lib", "/var/run"}

# Function to check if YARA is installed
def check_yara():
    try:
        subprocess.run(["yara", "--version"], check=True, capture_output=True, text=True)
        print("‚úÖ YARA is already installed.")
    except FileNotFoundError:
        print("‚ö†Ô∏è YARA is not installed. Installing now...")
        install_yara()

# Function to install YARA
def install_yara():
    try:
        subprocess.run(["sudo", "apt", "update"], check=True)
        subprocess.run(["sudo", "apt", "install", "-y", "yara"], check=True)
        print("‚úÖ YARA installation complete.")
    except subprocess.CalledProcessError:
        print("‚ùå Failed to install YARA. Please install it manually.")

# Function to scan files using YARA
def scan_files():
    print("\nüîç Starting YARA scan on the entire system...\n")

    for root, dirs, files in os.walk(SCAN_DIR):
        # Skip ignored directories
        if any(ignored in root for ignored in IGNORE_DIRS):
            continue

        for file in files:
            if file in IGNORE_FILES:
                continue

            file_path = os.path.join(root, file)

            try:
                result = subprocess.run(["yara", YARA_RULE, file_path],
                                        capture_output=True, text=True)
                if result.stdout:
                    print(f"‚ö†Ô∏è Malware detected in {file_path}:\n{result.stdout}")
                else:
                    print(f"‚úÖ No threats found in {file_path}")

            except PermissionError:
                print(f"‚ùå Permission denied: {file_path}")
            except Exception as e:
                print(f"‚ùå Error scanning {file_path}: {e}")

# Main execution
if __name__ == "__main__":
    check_yara()  # Ensure YARA is installed
    scan_files()  # Run the malware scan
EOT

echo "‚úÖ Installation complete! To run the scanner, use:"
echo "   python3 $INSTALL_DIR/scan_with_yara.py"

